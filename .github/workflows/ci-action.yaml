name: Awesome-DCIST-T4
on:
    push:
        branches: main
    pull_request:
        branches:
            - main
            - develop
env:
    ADT4_WS: ${{ github.workspace }}
    ADT4_ENV: ${{ github.workspace }}
    CCACHE_DIR: ${{ github.workspace }}
jobs:
  Awesome-DCIST-T4:
    runs-on: self-hosted
    container: osrf/ros:jazzy-desktop-full
    steps:
      - name: Clean Artifacts
        shell: bash
        run: |
          rm -rf src || rm -rf precommit_venv || rm -rf spark_env || rm -rf install

      - name: Update Dependencies
        shell: bash
        run: |
            sudo apt update
            sudo apt install -y git python3-pip python3 python3-virtualenv ros-jazzy-ament-cmake
            sudo apt install -y ccache
            ln -s /usr/bin/ccache  /usr/local/bin/gcc
            ln -s /usr/bin/ccache  /usr/local/bin/g++


      - name: Check out repository code
        uses: actions/checkout@v4
        with:
            path: src/awesome_dcist_t4
            submodules: recursive

      - name: Pre-commit
        shell: bash
        run: |
            python3 -m virtualenv precommit_venv --download
            source precommit_venv/bin/activate
            pip install pre-commit
            cd src/awesome_dcist_t4
            pre-commit run --all-files

      - name: ytt install
        uses: carvel-dev/setup-action@v2
        with:
          only: ytt

      - name: Python Install
        shell: bash
        run: |
            bash $ADT4_WS/src/awesome_dcist_t4/install/python_setup.bash --no-roman

      - name: Config Checks
        shell: bash
        run: ./src/awesome_dcist_t4/dcist_launch_system/scripts/check_configs.sh

      - name: Install Everything
        shell: bash
        run: |
            vcs import src < src/awesome_dcist_t4/install/packages.yaml
            rosdep update
            rosdep install -q --from-paths src --ignore-src -r -y || echo "Installed rosdeps"
            source /opt/ros/jazzy/setup.bash
            export PATH="/usr/lib/ccache:$PATH"
            ccache -s
            colcon build
            ccache -s

      - name: Test Python Dependencies
        shell: bash
        run: |
          python3 -c "from ruamel.yaml import YAML"
          source $ADT4_WS/install/setup.bash
          source $ADT4_ENV/spark_env/bin/activate
          pip install $ADT4_WS/src/awesome_dcist_t4/spark_dsg
          apt list --installed | grep ruamel
          python3 $ADT4_WS/src/awesome_dcist_t4/dcist_launch_system/scripts/test_python_imports.py


      - run: echo "🍏 This job's status is ${{ job.status }}."
