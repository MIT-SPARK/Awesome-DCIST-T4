name: Awesome-DCIST-T4
on:
    push:
        branches: main
    pull_request:
        branches:
            - main
            - develop
env:
    ADT4_WS: ${{ github.workspace }}
    ADT4_ENV: ${{ github.workspace }}
jobs:
  Awesome-DCIST-T4:
    runs-on: self-hosted
    container: osrf/ros:jazzy-desktop-full
    steps:
      - name: Clean Artifacts
        shell: bash
        run: |
          rm -rf src
          rm -rf spark_env
          rm -rf install
          rm -rf build

      - name: Update Dependencies
        shell: bash
        run: |
            sudo apt update
            sudo apt install -y git python3-pip pipx python3 python3-venv ros-jazzy-ament-cmake

      - name: Check out repository code
        uses: actions/checkout@v4
        with:
            path: src/awesome_dcist_t4
            submodules: false

      - name: Set up SSH for Private Submodules
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY_HYDRA_MULTI }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Update submodules
        shell: bash
        run: |
          cd src/awesome_dcist_t4
          git submodule update --init --recursive

      - name: Pre-commit
        shell: bash
        run: |
            cd src/awesome_dcist_t4
            pipx run pre-commit run --all-files

      - name: ytt install
        uses: carvel-dev/setup-action@v2
        with:
          only: ytt

      - name: Python Install
        shell: bash
        run: |
            bash $ADT4_WS/src/awesome_dcist_t4/install/python_setup.bash --no-roman

      - name: Install Everything
        shell: bash
        run: |
            vcs import src < src/awesome_dcist_t4/install/packages.yaml
            rosdep update
            rosdep install -q --from-paths src --ignore-src -r -y || echo "Installed rosdeps"
            source /opt/ros/jazzy/setup.bash
            colcon build

      - name: Test Python Dependencies
        shell: bash
        run: |
          source $ADT4_WS/install/setup.bash
          source $ADT4_ENV/spark_env/bin/activate
          pip install $ADT4_WS/src/awesome_dcist_t4/spark_dsg
          python3 $ADT4_WS/src/awesome_dcist_t4/dcist_launch_system/scripts/test_python_imports.py

      - name: Config Checks
        shell: bash
        run: ./src/awesome_dcist_t4/dcist_launch_system/scripts/check_configs.sh


      - run: echo "🍏 This job's status is ${{ job.status }}."
