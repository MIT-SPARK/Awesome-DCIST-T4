---
name: Awesome-DCIST-T4
on:
  merge_group:
    types: [checks_requested]
    paths-ignore:
      - README.md
      - CONTRIBUTING.md
      - 'scripts/**'
      - .gitignore
      - 'dotfiles/**'
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - README.md
      - CONTRIBUTING.md
      - 'scripts/**'
      - .gitignore
      - 'dotfiles/**'
env:
  ADT4_WS: ${{ github.workspace }}
  ADT4_ENV: ${{ github.workspace }}
  GIT_SSH_COMMAND: ssh -o StrictHostKeyChecking=no
jobs:
  Lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Dependencies
        run: sudo apt-get update && sudo apt install pipx
      - name: Lint
        run: pipx install pre-commit && cd ${{github.workspace}} && pre-commit run --all-files

  Build-and-Test:
    runs-on: ubuntu-latest
    container: osrf/ros:jazzy-desktop-full
    steps:
      - name: Update Dependencies
        shell: bash
        run: |
            sudo apt update
            sudo apt install -y git python3-pip pipx python3 python3-venv ros-jazzy-ament-cmake wget ccache

      - name: Setup SSH deploy key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY_HYDRA_MULTI }}

      - name: check loaded key
        run: ssh-add -l

      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          path: src/awesome_dcist_t4
          submodules: false
      - name: CCache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ${{ runner.os }}-ccache-${{ github.sha}}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ github.sha}}
            ${{ runner.os }}-ccache-

      - name: Update submodule urls
        working-directory: src/awesome_dcist_t4
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          git config --global url."https://github.com/".insteadOf git@github.com:
          git config --global url."git@github.com:MIT-SPARK/Hydra-Multi.git".insteadOf git@github.com:MIT-SPARK/Hydra-Multi.git

      - name: Update submodules
        working-directory: src/awesome_dcist_t4
        run: |
          git submodule update --init --recursive

      - name: Setup Workspace
        shell: bash
        run: |
            vcs import src < src/awesome_dcist_t4/install/packages.yaml
            rosdep update
            rosdep install -q --from-paths src --ignore-src -r -y || echo "Installed rosdeps"
            source /opt/ros/jazzy/setup.bash
            colcon build --packages-select config_utilities --cmake-args -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_COMPILER_LAUNCHER=ccache -DCMAKE_C_COMPILER_LAUNCHER=ccache

      - name: Config Checks
        shell: bash
        run: ./src/awesome_dcist_t4/dcist_launch_system/scripts/check_configs.sh

      - name: Python Install
        shell: bash
        run: |
            CMAKE_CXX_COMPILER_LAUNCHER=ccache bash $ADT4_WS/src/awesome_dcist_t4/install/python_setup.bash --no-roman

      - name: Build Everything
        shell: bash
        run: |
            source /opt/ros/jazzy/setup.bash
            colcon build --cmake-args -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_COMPILER_LAUNCHER=ccache -DCMAKE_C_COMPILER_LAUNCHER=ccache

      - name: Test Python Dependencies
        shell: bash
        run: |
          source $ADT4_WS/install/setup.bash
          source $ADT4_ENV/spark_env/bin/activate
          pip install $ADT4_WS/src/awesome_dcist_t4/spark_dsg
          python3 $ADT4_WS/src/awesome_dcist_t4/dcist_launch_system/scripts/test_python_imports.py

      - run: echo "🍏 This job's status is ${{ job.status }}."
